# =============================================================================
# Atomic Release Workflow (DO NOT USE)
# =============================================================================
#
# This reusable workflow handles the packaging and publishing process.
# It runs on multiple platforms (macOS, Windows, Linux) to:
#   - Download build artifacts
#   - Package the application
#   - Publish to GitHub Releases
#
# =============================================================================

name: Release (DO NOT USE)

on:
  workflow_call:

env:
  NODE_VERSION: '20'
  CI: true
  ELECTRON_ENABLE_LOGGING: true

jobs:
  # Pre-cleanup: Delete ALL existing assets before any platform uploads
  # This prevents race conditions when platforms run in parallel
  cleanup:
    name: Clean Existing Assets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Delete All Existing Release Assets
        run: |
          # Get version from package.json (works for both tag and manual triggers)
          VERSION=$(node -p "require('./package.json').version")
          TAG="v${VERSION}"
          echo "Looking for release with tag: $TAG"
          
          # Get release info - properly handle 404 when release doesn't exist
          RESPONSE=$(gh api repos/${{ github.repository }}/releases/tags/$TAG 2>&1) || true
          
          # Check if release exists
          if echo "$RESPONSE" | grep -q '"message":"Not Found"'; then
            echo "No existing release found for tag $TAG, skipping asset deletion"
            echo "This is expected for first-time releases."
            exit 0
          fi
          
          # Extract release ID
          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "Could not extract release ID, skipping asset deletion"
            exit 0
          fi

          echo "================================================="
          echo "Deleting ALL existing assets for Release ID: $RELEASE_ID"
          echo "================================================="

          # Count assets before deletion
          ASSET_COUNT=$(gh api repos/${{ github.repository }}/releases/$RELEASE_ID/assets --paginate --jq '. | length')
          echo "Total assets to delete: $ASSET_COUNT"
          echo ""

          # Delete ALL assets (will be rebuilt by the platform jobs)
          gh api repos/${{ github.repository }}/releases/$RELEASE_ID/assets --paginate --jq '.[] | "\(.id)\t\(.name)"' | while read -r line; do
            ASSET_ID=$(echo "$line" | cut -f1)
            ASSET_NAME=$(echo "$line" | cut -f2)

            echo "[DELETE] Asset: '$ASSET_NAME' (ID: $ASSET_ID)"
            if gh api -X DELETE repos/${{ github.repository }}/releases/assets/$ASSET_ID 2>&1; then
              echo "  ✓ Successfully deleted"
            else
              echo "  ⚠ Failed to delete (might be already deleted)"
            fi
          done

          echo ""
          echo "================================================="
          echo "Waiting 15 seconds for GitHub API propagation..."
          echo "================================================="
          sleep 15
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        continue-on-error: true

  release:
    name: Release (${{ matrix.os }}${{ matrix.arch && format(' {0}', matrix.arch) || '' }})
    needs: cleanup  # Wait for cleanup to finish
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS: Build x64 and arm64 separately to avoid upload collisions
          - os: macos-latest
            arch: x64
          - os: macos-latest
            arch: arm64
          # Windows and Linux: single architecture
          - os: ubuntu-latest
            arch: ''
          - os: windows-latest
            arch: ''

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # Download build artifacts from _build.yml
      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/
      
      - name: Download Electron Build
        uses: actions/download-artifact@v4
        with:
          name: electron-dist
          path: dist-electron/

      # Run Electron Builder
      # This step builds the artifacts and uploads them to the GitHub Release
      # For macOS: build only the specified architecture to avoid upload collisions
      - name: Build & Publish via Electron Builder
        run: |
          if [ -n "${{ matrix.arch }}" ]; then
            echo "Building for macOS ${{ matrix.arch }} only"
            npx --yes electron-builder --mac --${{ matrix.arch }} --publish always
          else
            echo "Building for ${{ runner.os }}"
            npx --yes electron-builder --publish always
          fi
        shell: bash
        env:
          # GitHub token for publishing releases
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # macOS Signing & Notarization Secrets (Optional - Empty = Unsigned)
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          
          # Windows Signing Secrets (Optional - Empty = Unsigned)
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}

      # Upload build artifacts for debugging if needed
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-artifacts-${{ matrix.os }}${{ matrix.arch && format('-{0}', matrix.arch) || '' }}
          path: release/
          retention-days: 7
          if-no-files-found: ignore
