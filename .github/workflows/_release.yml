# =============================================================================
# Atomic Release Workflow (Reusable)
# =============================================================================
#
# This reusable workflow handles the packaging and publishing process.
# It runs explicit separate jobs per platform/architecture following
# industry best practices (Bitwarden/Zettlr pattern) to avoid upload collisions.
#
# =============================================================================

name: Release (Reusable)

on:
  workflow_call:

env:
  NODE_VERSION: '20'
  CI: true
  ELECTRON_ENABLE_LOGGING: true

jobs:
  # Pre-cleanup: Delete ALL existing assets before any platform uploads
  # This prevents race conditions when platforms run in parallel
  cleanup:
    name: Clean Existing Assets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Delete Existing Draft Release
        run: |
          # Get version from package.json (works for both tag and manual triggers)
          VERSION=$(node -p "require('./package.json').version")
          TAG="v${VERSION}"
          echo "Looking for release with tag: $TAG"
          
          # Get release info - properly handle 404 when release doesn't exist
          RESPONSE=$(gh api repos/${{ github.repository }}/releases/tags/$TAG 2>&1) || true
          
          # Check if release exists
          if echo "$RESPONSE" | grep -q '"message":"Not Found"'; then
            echo "No existing release found for tag $TAG"
            echo "This is expected for first-time releases."
            exit 0
          fi
          
          # Extract release ID and check if it's a draft
          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
          IS_DRAFT=$(echo "$RESPONSE" | jq -r '.draft')
          
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "Could not extract release ID, skipping cleanup"
            exit 0
          fi

          echo "================================================="
          echo "Found release ID: $RELEASE_ID (draft: $IS_DRAFT)"
          echo "================================================="

          # Only delete draft releases to avoid accidentally deleting published releases
          if [ "$IS_DRAFT" = "true" ]; then
            echo "Deleting entire draft release to ensure clean slate..."
            if gh api -X DELETE repos/${{ github.repository }}/releases/$RELEASE_ID 2>&1; then
              echo "✓ Successfully deleted draft release $RELEASE_ID"
            else
              echo "⚠ Failed to delete draft release (might be already deleted)"
            fi
          else
            echo "Release is not a draft, deleting assets only..."
            # Delete ALL assets (will be rebuilt by the platform jobs)
            gh api repos/${{ github.repository }}/releases/$RELEASE_ID/assets --paginate --jq '.[] | "\(.id)\t\(.name)"' | while read -r line; do
              ASSET_ID=$(echo "$line" | cut -f1)
              ASSET_NAME=$(echo "$line" | cut -f2)
              echo "[DELETE] Asset: '$ASSET_NAME' (ID: $ASSET_ID)"
              gh api -X DELETE repos/${{ github.repository }}/releases/assets/$ASSET_ID 2>&1 || true
            done
          fi

          echo ""
          echo "================================================="
          echo "Waiting 10 seconds for GitHub API propagation..."
          echo "================================================="
          sleep 10
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        continue-on-error: true

  # ==========================================================================
  # macOS Builds - Separate jobs per architecture (Bitwarden/Zettlr pattern)
  # ==========================================================================
  
  macos-x64:
    name: macOS (x64)
    needs: cleanup
    runs-on: macos-latest
    env:
      npm_config_arch: x64
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/
      
      - name: Download Electron Build
        uses: actions/download-artifact@v4
        with:
          name: electron-dist
          path: dist-electron/

      - name: Build & Publish (macOS x64)
        run: npm run dist:mac-x64 -- --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-artifacts-macos-x64
          path: release/
          retention-days: 7
          if-no-files-found: ignore

  macos-arm64:
    name: macOS (arm64)
    needs: [cleanup, macos-x64]  # Wait for x64 to finish to avoid upload conflicts
    runs-on: macos-latest
    env:
      npm_config_arch: arm64
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/
      
      - name: Download Electron Build
        uses: actions/download-artifact@v4
        with:
          name: electron-dist
          path: dist-electron/

      - name: Build & Publish (macOS arm64)
        run: npm run dist:mac-arm64 -- --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-artifacts-macos-arm64
          path: release/
          retention-days: 7
          if-no-files-found: ignore

  # ==========================================================================
  # Windows Build
  # ==========================================================================
  
  windows:
    name: Windows (x64)
    needs: cleanup
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/
      
      - name: Download Electron Build
        uses: actions/download-artifact@v4
        with:
          name: electron-dist
          path: dist-electron/

      - name: Build & Publish (Windows)
        run: npm run dist:win -- --publish always
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-artifacts-windows
          path: release/
          retention-days: 7
          if-no-files-found: ignore

  # ==========================================================================
  # Linux Build
  # ==========================================================================
  
  linux:
    name: Linux (x64)
    needs: cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/
      
      - name: Download Electron Build
        uses: actions/download-artifact@v4
        with:
          name: electron-dist
          path: dist-electron/

      - name: Build & Publish (Linux)
        run: npm run dist:linux -- --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-artifacts-linux
          path: release/
          retention-days: 7
          if-no-files-found: ignore
